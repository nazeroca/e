<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Cyber P2P Streamer</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

<style>
    :root {
        --bg-main: #050008;
        --neon-pink: #ff0055;
        --neon-blue: #00d2ff;
        --neon-green: #00ff99;
        --text-main: #eee;
    }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { background: var(--bg-main); color: var(--text-main); margin: 0; font-family: sans-serif; overflow: hidden; height: 100vh; display: flex; flex-direction: column; }

    .screen { position: absolute; top:0; left:0; width:100%; height:100%; display:none; flex-direction: column; align-items: center; justify-content: center; background: var(--bg-main); }
    .active { display: flex; }

    h1 { color: var(--neon-blue); text-shadow: 0 0 10px var(--neon-blue); margin-bottom: 20px; font-size: 24px; }
    
    .btn {
        background: transparent; border: 2px solid var(--neon-pink); color: var(--neon-pink);
        padding: 15px 30px; font-size: 18px; font-weight: bold; border-radius: 50px;
        margin: 10px; cursor: pointer; transition: 0.2s; text-align: center; width: 240px;
        box-shadow: 0 0 10px rgba(255,0,85,0.2);
    }
    .btn:active { background: var(--neon-pink); color: #fff; transform: scale(0.95); }
    .btn-blue { border-color: var(--neon-blue); color: var(--neon-blue); box-shadow: 0 0 10px rgba(0,210,255,0.2); }
    .btn-blue:active { background: var(--neon-blue); color: #000; }

    /* „É¢„Éã„Çø„ÉºÁî® */
    #monitor-img { max-width: 100%; max-height: 100%; object-fit: contain; }
    
    #qrcode { margin: 20px; padding: 10px; background: #fff; border-radius: 8px; }
    .status-log { font-family: monospace; color: #888; font-size: 12px; margin-top: 10px; }
    #reader-cam { width: 300px; height: 300px; background: #000; border: 2px solid var(--neon-green); margin-bottom: 20px; }
    
    /* „Ç≥„É≥„Éà„É≠„Éº„É©„ÉºUI */
    #controller-ui { width: 100%; height: 100%; display: flex; flex-direction: column; }
    
    /* ‰∏äÈÉ®„Éê„Éº */
    #ctrl-header { 
        padding: 10px; background: #111; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; height: 60px;
    }
    .file-select-btn {
        background: #222; border: 1px solid #555; color: #eee; padding: 5px 10px; border-radius: 4px; font-size: 12px; cursor: pointer;
    }
    .shake-btn {
        background: #222; border: 1px solid var(--neon-green); color: var(--neon-green); padding: 5px 10px; border-radius: 4px; font-size: 10px; cursor: pointer;
    }
    .shake-active { background: var(--neon-green); color: #000; }

    /* „Éó„É¨„Éì„É•„Éº„Ç®„É™„Ç¢ */
    #preview-container { 
        flex: 1; display: flex; justify-content: center; align-items: center; 
        background: #000; overflow: hidden; position: relative;
    }
    #preview-canvas { max-width: 95%; max-height: 95%; opacity: 0.8; box-shadow: 0 0 15px rgba(0,210,255,0.2); }
    #preview-overlay { 
        position: absolute; font-size: 20px; color: rgba(255,255,255,0.3); 
        font-weight: bold; pointer-events: none; text-align: center;
    }

    /* ‰∏ãÈÉ®„Éú„Çø„É≥ */
    #ctrl-footer { height: 100px; display: flex; border-top: 1px solid #333; }
    .nav-btn { flex: 1; background: #1a1a1a; color: #fff; border: none; font-size: 18px; font-weight: bold; cursor: pointer; border-right: 1px solid #333; }
    .nav-btn:active { background: #333; }
    #btn-prev { flex: 1; color: #888; }
    #btn-skip { flex: 1; color: var(--neon-pink); font-size: 14px; }
    #btn-next { flex: 2; color: var(--neon-blue); font-size: 24px; border-right: none; }
    
    input[type="file"] { display: none; }
</style>
</head>
<body>

<div id="screen-mode" class="screen active">
    <h1>CYBER STREAMER</h1>
    <button class="btn btn-blue" onclick="startReceiver()">üì∫ MONITOR<br><span style="font-size:12px">(Tablet)</span></button>
    <button class="btn" onclick="startSender()">üì± REMOTE<br><span style="font-size:12px">(Phone)</span></button>
</div>

<div id="screen-receiver" class="screen">
    <div id="wait-ui" style="display:flex; flex-direction:column; align-items:center;">
        <h2 style="color:var(--neon-blue)">WAITING...</h2>
        <div id="qrcode"></div>
        <div class="status-log" id="recv-status">Scan QR with Remote</div>
    </div>
    <img id="monitor-img" style="display:none;">
</div>

<div id="screen-sender" class="screen">
    <div id="scan-ui" style="display:flex; flex-direction:column; align-items:center;">
        <h2 style="color:var(--neon-pink)">SCAN QR</h2>
        <div id="reader-cam"></div>
        <div class="status-log" id="send-status">Camera initializing...</div>
    </div>

    <div id="controller-ui" style="display:none;">
        <div id="ctrl-header">
            <label class="file-select-btn">
                üìÇ ADD PDFS
                <input type="file" id="file-input" accept="application/pdf" multiple>
            </label>
            <div id="file-info" style="font-size:10px; color:#aaa; max-width: 100px; overflow:hidden; white-space:nowrap;">No File</div>
            <button id="btn-shake" class="shake-btn" onclick="enableShake()">üì≥ SHAKE: OFF</button>
        </div>
        
        <div id="preview-container" onclick="onNextPage()">
            <canvas id="preview-canvas"></canvas>
            <div id="preview-overlay">TAP or SHAKE<br>TO NEXT</div>
        </div>

        <div id="ctrl-footer">
            <button id="btn-prev" class="nav-btn" onclick="event.stopPropagation(); onPrevPage()">PREV</button>
            <button id="btn-skip" class="nav-btn" onclick="event.stopPropagation(); loadNextPdf()">SKIP<br>PDF</button>
            <button id="btn-next" class="nav-btn" onclick="event.stopPropagation(); onNextPage()">NEXT</button>
        </div>
    </div>
</div>

<script>
    let peer = null;
    let conn = null;
    let pdfDoc = null;
    let pageNum = 1;
    let pdfRendering = false;
    let pageNumPending = null;

    // „Éó„É¨„Ç§„É™„Çπ„ÉàÁÆ°ÁêÜ
    let playlist = []; // File„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÅÆÈÖçÂàó
    let currentFileIndex = -1;

    // „Ç∑„Çß„Ç§„ÇØÊ§úÁü•Áî®
    let shakeEnabled = false;
    let lastShakeTime = 0;

    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

    // === RECEIVER ===
    function startReceiver() {
        switchScreen('screen-receiver');
        peer = new Peer();
        peer.on('open', (id) => {
            new QRCode(document.getElementById("qrcode"), { text: id, width: 180, height: 180 });
            updateStatus("recv-status", "Ready.");
        });
        peer.on('connection', (c) => {
            conn = c;
            conn.on('open', () => {
                updateStatus("recv-status", "Connected!");
                document.getElementById('wait-ui').style.display = 'none';
                document.getElementById('monitor-img').style.display = 'block';
            });
            conn.on('data', (data) => {
                if (data.type === 'IMG') {
                    document.getElementById('monitor-img').src = data.payload;
                }
            });
        });
    }

    // === SENDER ===
    function startSender() {
        switchScreen('screen-sender');
        const html5QrCode = new Html5Qrcode("reader-cam");
        html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: { width: 250, height: 250 } }, (decodedText) => {
            html5QrCode.stop();
            connectToReceiver(decodedText);
        });
    }

    function connectToReceiver(targetId) {
        updateStatus("send-status", "Connecting...");
        peer = new Peer();
        peer.on('open', () => {
            conn = peer.connect(targetId);
            conn.on('open', () => {
                document.getElementById('scan-ui').style.display = 'none';
                document.getElementById('controller-ui').style.display = 'flex';
            });
        });
    }

    // === „Éï„Ç°„Ç§„É´Âá¶ÁêÜ & „Éó„É¨„Ç§„É™„Çπ„Éà ===
    document.getElementById('file-input').addEventListener('change', (e) => {
        const files = Array.from(e.target.files);
        if (files.length === 0) return;
        
        // „Éó„É¨„Ç§„É™„Çπ„Éà„Å´ËøΩÂä†„Åó„Å¶„Ç∑„É£„ÉÉ„Éï„É´
        playlist = playlist.concat(files);
        shuffleArray(playlist);

        // „Åæ„Å†ÂÜçÁîü„Åó„Å¶„Å™„Åë„Çå„Å∞ÈñãÂßã
        if (currentFileIndex === -1) {
            loadNextPdf();
        } else {
            document.getElementById('file-info').innerText = `Queued: ${playlist.length} files`;
        }
    });

    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
    }

    function loadNextPdf() {
        if (playlist.length === 0) {
            alert("No more PDFs in playlist!");
            return;
        }

        // Ê¨°„ÅÆ„Éï„Ç°„Ç§„É´„Å∏Ôºà„É´„Éº„Éó„Åï„Åõ„Çã„Å™„Çâ„Åì„Åì„ÇíË™øÊï¥Ôºâ
        currentFileIndex = (currentFileIndex + 1) % playlist.length;
        const file = playlist[currentFileIndex];
        
        // UIÊõ¥Êñ∞
        document.getElementById('file-info').innerText = file.name;

        const url = URL.createObjectURL(file);
        pdfjsLib.getDocument(url).promise.then((pdf) => {
            pdfDoc = pdf;
            pageNum = 1;
            renderAndSend(pageNum);
        }).catch(err => {
            console.error(err);
            // Â£ä„Çå„Åü„Éï„Ç°„Ç§„É´„Å™„ÇâÊ¨°„Å∏
            loadNextPdf();
        });
    }

    // === „É¨„É≥„ÉÄ„É™„É≥„Ç∞ & ÈÄÅ‰ø° ===
    function renderAndSend(num) {
        if(pdfRendering) { pageNumPending = num; return; }
        pdfRendering = true;

        pdfDoc.getPage(num).then((page) => {
            const canvas = document.getElementById('preview-canvas');
            const ctx = canvas.getContext('2d');
            const viewport = page.getViewport({scale: 1.0}); // „Çπ„Éû„Éõ„Éó„É¨„Éì„É•„ÉºÁî®„ÅØËªΩÈáè„ÅßOK

            canvas.height = viewport.height;
            canvas.width = viewport.width;

            const renderTask = page.render({ canvasContext: ctx, viewport: viewport });

            renderTask.promise.then(() => {
                pdfRendering = false;
                
                // „Ç™„Éº„Éê„Éº„É¨„Ç§Ë°®Á§∫Êõ¥Êñ∞
                const info = `${num} / ${pdfDoc.numPages}`;
                document.getElementById('preview-overlay').innerText = info;

                // ÈÄÅ‰ø°Áî®„Å´È´òÁîªË≥™ÂåñÔºàÂøÖË¶Å„Å´Âøú„Åò„Å¶scaleË™øÊï¥Ôºâ
                // toDataURLÊôÇ„Å´ÁîªË≥™ÊåáÂÆö
                const imgData = canvas.toDataURL('image/jpeg', 0.8);
                
                if(conn && conn.open) {
                    conn.send({ type: 'IMG', payload: imgData });
                }

                if (pageNumPending !== null) {
                    renderAndSend(pageNumPending);
                    pageNumPending = null;
                }
            });
        });
    }

    // === „Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥ ===
    function onPrevPage() {
        if (!pdfDoc) return;
        if (pageNum <= 1) return; 
        pageNum--;
        renderAndSend(pageNum);
    }

    function onNextPage() {
        if (!pdfDoc) return;
        if (pageNum >= pdfDoc.numPages) {
            // ÊúÄÁµÇ„Éö„Éº„Ç∏„Å™„ÇâÊ¨°„ÅÆPDF„Å∏
            loadNextPdf();
        } else {
            pageNum++;
            renderAndSend(pageNum);
        }
    }

    // === „Ç∑„Çß„Ç§„ÇØÊ©üËÉΩ (Âä†ÈÄüÂ∫¶„Çª„É≥„Çµ„Éº) ===
    function enableShake() {
        if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
            // iOS 13+
            DeviceMotionEvent.requestPermission()
                .then(response => {
                    if (response === 'granted') {
                        startMotionListener();
                    } else {
                        alert("Permission denied");
                    }
                })
                .catch(console.error);
        } else {
            // Android / Old iOS
            startMotionListener();
        }
    }

    function startMotionListener() {
        shakeEnabled = true;
        const btn = document.getElementById('btn-shake');
        btn.innerText = "üì≥ SHAKE: ON";
        btn.classList.add('shake-active');

        window.addEventListener('devicemotion', (event) => {
            const acc = event.acceleration; // ÈáçÂäõ„ÇíÈô§„ÅèÂä†ÈÄüÂ∫¶
            if (!acc) return;

            // „Ç∑„Çß„Ç§„ÇØÊ§úÁü•„É≠„Ç∏„ÉÉ„ÇØ (Á∞°ÊòìÁâà: ÂêàÊàê„Éô„ÇØ„Éà„É´„ÅåÈñæÂÄ§Ë∂Ö„Åà)
            const strength = Math.sqrt(acc.x * acc.x + acc.y * acc.y + acc.z * acc.z);
            
            // ÈñæÂÄ§ 15m/s^2 (Âº∑„ÇÅ„Å´ÊåØ„Çã)
            if (strength > 15) {
                const now = Date.now();
                // Ë™§ÁàÜÈò≤Ê≠¢: 0.8Áßí‰ª•ÂÜÖ„ÅÆÈÄ£Á∂öÊ§úÁü•„ÅØÁÑ°Ë¶ñ
                if (now - lastShakeTime > 800) {
                    lastShakeTime = now;
                    // „Éê„Ç§„Éñ„É¨„Éº„Ç∑„Éß„É≥ (Android„ÅÆ„ÅøÂØæÂøú)
                    if (navigator.vibrate) navigator.vibrate(50);
                    onNextPage();
                }
            }
        });
    }

    // „É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£
    function switchScreen(id) { document.querySelectorAll('.screen').forEach(el => el.classList.remove('active')); document.getElementById(id).classList.add('active'); }
    function updateStatus(id, msg) { document.getElementById(id).innerText = msg; }
</script>
</body>
</html>

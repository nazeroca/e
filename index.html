<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>M5 Instant Streamer</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

<style>
    :root {
        --bg-main: #050008;
        --neon-pink: #ff0055;
        --neon-blue: #00d2ff;
        --neon-green: #00ff99;
        --text-main: #eee;
    }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { background: var(--bg-main); color: var(--text-main); margin: 0; font-family: sans-serif; overflow: hidden; height: 100vh; display: flex; flex-direction: column; }

    .screen { position: absolute; top:0; left:0; width:100%; height:100%; display:none; flex-direction: column; align-items: center; justify-content: center; background: var(--bg-main); }
    .active { display: flex; }

    h1 { color: var(--neon-blue); text-shadow: 0 0 10px var(--neon-blue); margin-bottom: 20px; font-size: 24px; }
    
    .btn {
        background: transparent; border: 2px solid var(--neon-pink); color: var(--neon-pink);
        padding: 15px 30px; font-size: 18px; font-weight: bold; border-radius: 50px;
        margin: 10px; cursor: pointer; transition: 0.2s; text-align: center; width: 240px;
        box-shadow: 0 0 10px rgba(255,0,85,0.2);
    }
    .btn:active { background: var(--neon-pink); color: #fff; transform: scale(0.95); }
    .btn-blue { border-color: var(--neon-blue); color: var(--neon-blue); box-shadow: 0 0 10px rgba(0,210,255,0.2); }
    .btn-blue:active { background: var(--neon-blue); color: #000; }

    /* „É¢„Éã„Çø„ÉºÁî®ÁîªÂÉè */
    #monitor-img { max-width: 100%; max-height: 100%; object-fit: contain; }
    
    #qrcode { margin: 20px; padding: 10px; background: #fff; border-radius: 8px; }
    .status-log { font-family: monospace; color: #888; font-size: 12px; margin-top: 10px; }
    #reader-cam { width: 300px; height: 300px; background: #000; border: 2px solid var(--neon-green); margin-bottom: 20px; }
    
    /* „Ç≥„É≥„Éà„É≠„Éº„É©„ÉºUI */
    #controller-ui { width: 100%; height: 100%; display: flex; flex-direction: column; }
    #ctrl-header { padding: 15px; background: #111; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; }
    
    /* „Éó„É¨„Éì„É•„Éº„Ç®„É™„Ç¢Ôºà„Çπ„Éû„ÉõÂÅ¥„Å´Â∞è„Åï„ÅèË°®Á§∫Ôºâ */
    #preview-container { flex: 1; display: flex; justify-content: center; align-items: center; background: #111; overflow: hidden; position: relative;}
    #preview-canvas { max-width: 90%; max-height: 90%; opacity: 0.5; } 
    #preview-overlay { position: absolute; font-size: 40px; color: rgba(255,255,255,0.2); font-weight: bold; pointer-events: none; }

    /* Êìç‰Ωú„Éú„Çø„É≥ */
    #ctrl-footer { height: 120px; display: flex; border-top: 1px solid #333; }
    .nav-btn { flex: 1; background: #1a1a1a; color: #fff; border: none; font-size: 24px; font-weight: bold; cursor: pointer; }
    .nav-btn:active { background: #333; }
    #btn-prev { border-right: 1px solid #333; color: var(--neon-pink); }
    #btn-next { color: var(--neon-blue); flex: 2; } /* Ê¨°„Å∏„Éú„Çø„É≥„ÇíÂ§ß„Åç„Åè */
    
    input[type="file"] { display: none; }
</style>
</head>
<body>

<div id="screen-mode" class="screen active">
    <h1>M5 INSTANT</h1>
    <button class="btn btn-blue" onclick="startReceiver()">üì∫ MONITOR<br><span style="font-size:12px">(Tablet)</span></button>
    <button class="btn" onclick="startSender()">üì± REMOTE<br><span style="font-size:12px">(Phone)</span></button>
</div>

<div id="screen-receiver" class="screen">
    <div id="wait-ui" style="display:flex; flex-direction:column; align-items:center;">
        <h2 style="color:var(--neon-blue)">WAITING...</h2>
        <div id="qrcode"></div>
        <div class="status-log" id="recv-status">Scan QR with Remote</div>
    </div>
    <img id="monitor-img" style="display:none;">
</div>

<div id="screen-sender" class="screen">
    <div id="scan-ui" style="display:flex; flex-direction:column; align-items:center;">
        <h2 style="color:var(--neon-pink)">SCAN QR</h2>
        <div id="reader-cam"></div>
        <div class="status-log" id="send-status">Camera initializing...</div>
    </div>

    <div id="controller-ui" style="display:none;">
        <div id="ctrl-header">
            <label class="btn-blue" style="padding: 5px 15px; border-radius: 5px; font-size: 12px; cursor: pointer;">
                üìÇ OPEN PDF
                <input type="file" id="file-input" accept="application/pdf">
            </label>
            <div id="page-info" style="font-family: monospace; font-size: 14px;">- / -</div>
        </div>
        
        <div id="preview-container" onclick="onNextPage()"> <canvas id="preview-canvas"></canvas>
            <div id="preview-overlay">TAP TO NEXT</div>
        </div>

        <div id="ctrl-footer">
            <button id="btn-prev" class="nav-btn" onclick="event.stopPropagation(); onPrevPage()">PREV</button>
            <button id="btn-next" class="nav-btn" onclick="event.stopPropagation(); onNextPage()">NEXT</button>
        </div>
    </div>
</div>

<script>
    let peer = null;
    let conn = null;
    let pdfDoc = null;
    let pageNum = 1;
    let pdfRendering = false;
    let pageNumPending = null;

    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

    // === RECEIVER (Monitor) ===
    function startReceiver() {
        switchScreen('screen-receiver');
        peer = new Peer();
        peer.on('open', (id) => {
            new QRCode(document.getElementById("qrcode"), { text: id, width: 180, height: 180 });
            updateStatus("recv-status", "Ready.");
        });
        peer.on('connection', (c) => {
            conn = c;
            setupReceiver();
        });
    }

    function setupReceiver() {
        conn.on('open', () => {
            updateStatus("recv-status", "Connected!");
            document.getElementById('wait-ui').style.display = 'none';
            document.getElementById('monitor-img').style.display = 'block';
        });
        conn.on('data', (data) => {
            // Âèó‰ø°„Åó„ÅüÁîªÂÉè„Éá„Éº„Çø„Çí„Åù„ÅÆ„Åæ„ÅæË°®Á§∫
            if (data.type === 'IMG') {
                document.getElementById('monitor-img').src = data.payload;
            }
        });
    }

    // === SENDER (Remote) ===
    function startSender() {
        switchScreen('screen-sender');
        const html5QrCode = new Html5Qrcode("reader-cam");
        html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: { width: 250, height: 250 } }, (decodedText) => {
            html5QrCode.stop();
            connectToReceiver(decodedText);
        });
    }

    function connectToReceiver(targetId) {
        updateStatus("send-status", "Connecting...");
        peer = new Peer();
        peer.on('open', () => {
            conn = peer.connect(targetId);
            conn.on('open', () => {
                document.getElementById('scan-ui').style.display = 'none';
                document.getElementById('controller-ui').style.display = 'flex';
            });
        });
    }

    // === PDF Processing („Çπ„Éû„ÉõÂÅ¥„Åß„É¨„É≥„ÉÄ„É™„É≥„Ç∞) ===
    document.getElementById('file-input').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        const url = URL.createObjectURL(file);
        pdfjsLib.getDocument(url).promise.then((pdf) => {
            pdfDoc = pdf;
            pageNum = 1;
            renderAndSend(pageNum);
        });
    });

    function renderAndSend(num) {
        if(pdfRendering) { pageNumPending = num; return; }
        pdfRendering = true;

        pdfDoc.getPage(num).then((page) => {
            // 1. „Çπ„Éû„Éõ‰∏ä„ÅÆCanvas„Å´ÊèèÁîª („Éó„É¨„Éì„É•„ÉºÁî®)
            const canvas = document.getElementById('preview-canvas');
            const ctx = canvas.getContext('2d');
            
            // ÁîªË≥™Ë®≠ÂÆö: „Çø„Éñ„É¨„ÉÉ„Éà„ÅßË¶ã„Å¶„ÇÇËçí„Åè„Å™„Çâ„Å™„ÅÑÁ®ãÂ∫¶„ÅÆËß£ÂÉèÂ∫¶„Åß„É¨„É≥„ÉÄ„É™„É≥„Ç∞
            // scale 1.5 „Äú 2.0 „Åè„Çâ„ÅÑ„Åå„Éê„É©„É≥„ÇπËâØ„Åó
            const viewport = page.getViewport({scale: 1.5}); 

            canvas.height = viewport.height;
            canvas.width = viewport.width;

            const renderTask = page.render({ canvasContext: ctx, viewport: viewport });

            renderTask.promise.then(() => {
                pdfRendering = false;
                
                // UIÊõ¥Êñ∞
                document.getElementById('page-info').innerText = `${num} / ${pdfDoc.numPages}`;
                
                // 2. ÁîªÂÉè„Éá„Éº„Çø(JPEG)„Å´Â§âÊèõ„Åó„Å¶ÈÄÅ‰ø°
                // JPEG quality 0.8 „ÅßÂÆπÈáèÂâäÊ∏õ
                const imgData = canvas.toDataURL('image/jpeg', 0.8);
                
                if(conn && conn.open) {
                    conn.send({ type: 'IMG', payload: imgData });
                }

                if (pageNumPending !== null) {
                    renderAndSend(pageNumPending);
                    pageNumPending = null;
                }
            });
        });
    }

    function onPrevPage() { if (pageNum <= 1) return; pageNum--; renderAndSend(pageNum); }
    function onNextPage() { if (!pdfDoc || pageNum >= pdfDoc.numPages) return; pageNum++; renderAndSend(pageNum); }

    function switchScreen(id) { document.querySelectorAll('.screen').forEach(el => el.classList.remove('active')); document.getElementById(id).classList.add('active'); }
    function updateStatus(id, msg) { document.getElementById(id).innerText = msg; }
</script>
</body>
</html>
